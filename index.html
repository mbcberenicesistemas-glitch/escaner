<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escáner de Artículos - Caducidad, Clave, Cantidad</title>

    <!-- PWA -->
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#2c3e50">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- ZXing (lector de códigos por cámara) -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f0f2f5; color: #333; padding: 20px; max-width: 1200px; margin: 0 auto; }
        header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 25px; text-align: center; }
        h1 { font-size: 2.2rem; margin-bottom: 10px; }
        .subtitle { font-size: 1.1rem; opacity: 0.9; max-width: 700px; margin: 0 auto; }
        .container { display: flex; flex-direction: column; gap: 25px; }
        .scanner-section { background-color: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .scanner-header { display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eaeaea; }
        .scanner-header i { font-size: 1.8rem; color: #3498db; margin-right: 15px; }
        .scanner-header h2 { font-size: 1.5rem; color: #2c3e50; }
        .input-row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        .input-group { flex: 1; min-width: 200px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #444; font-size: 0.95rem; }
        input, select { width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem; transition: all 0.3s; }
        input:focus, select:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52,152,219,0.2); }
        .buttons { display: flex; gap: 15px; margin-top: 25px; }
        button { padding: 12px 20px; border: none; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .scan-btn { background-color: #2ecc71; color: white; flex: 1; }
        .scan-btn:hover { background-color: #27ae60; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(46,204,113,0.3); }

        .clear-all-section { background-color: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 2px solid #ffeaa7; }
        .clear-all-header { display: flex; align-items: center; margin-bottom: 15px; }
        .clear-all-header i { font-size: 1.8rem; color: #e74c3c; margin-right: 15px; }
        .clear-all-header h2 { font-size: 1.5rem; color: #2c3e50; }
        .clear-all-warning { background-color: #fff9e6; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #f1c40f; }
        .clear-all-btn { background-color: #e74c3c; color: white; width: 100%; }
        .clear-all-btn:hover { background-color: #c0392b; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(231,76,60,0.3); }

        .results-section { background-color: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow-x: auto; }
        .results-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eaeaea; }
        .results-header h2 { font-size: 1.5rem; color: #2c3e50; display: flex; align-items: center; gap: 10px; }
        .results-header i { font-size: 1.5rem; color: #3498db; }
        .results-header-actions { display: flex; gap: 10px; }
        .export-btn { background-color: #3498db; color: white; padding: 10px 15px; font-size: 0.9rem; }
        .export-btn:hover { background-color: #2980b9; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 600px; }
        th { background-color: #f8f9fa; padding: 16px 12px; text-align: left; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #eaeaea; position: sticky; top: 0; }
        td { padding: 14px 12px; border-bottom: 1px solid #eaeaea; color: #555; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f9fafb; }

        .caducidad-cell { font-weight: 600; color: #e74c3c; min-width: 120px; }
        .clave-cell { font-weight: 700; color: #2c3e50; min-width: 150px; }
        .cantidad-cell { text-align: center; font-weight: 700; color: #2ecc71; min-width: 100px; }

        .summary { margin-top: 25px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .total-items { font-size: 1.1rem; font-weight: 600; color: #2c3e50; }
        .total-items span { color: #3498db; font-size: 1.3rem; }

        .instructions { background-color: #e8f4fd; border-left: 5px solid #3498db; padding: 20px; border-radius: 8px; margin-top: 25px; }
        .instructions h3 { color: #2c3e50; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .instructions ul { padding-left: 20px; line-height: 1.6; }
        .instructions li { margin-bottom: 8px; }

        .empty-state { text-align: center; padding: 50px 20px; color: #888; }
        .empty-state i { font-size: 3rem; margin-bottom: 15px; color: #ccc; }
        .empty-state p { font-size: 1.1rem; }

        .filter-section { background-color: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .filter-row { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-label { font-weight: 600; color: #555; font-size: 0.9rem; }
        .filter-input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 150px; }
        .filter-btn { background-color: #95a5a6; color: white; padding: 8px 15px; font-size: 0.9rem; }
        .filter-btn:hover { background-color: #7f8c8d; }

        @media (max-width: 768px) {
            .input-row { flex-direction: column; }
            .buttons { flex-direction: column; }
            .summary { flex-direction: column; align-items: flex-start; }
            h1 { font-size: 1.8rem; }
            .results-header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .filter-row { flex-direction: column; align-items: flex-start; }
        }

        .notification { position: fixed; top: 20px; right: 20px; background-color: #2ecc71; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; z-index: 1000; transform: translateX(150%); transition: transform 0.5s ease; }
        .notification.show { transform: translateX(0); }
        .notification.error { background-color: #e74c3c; }
        .notification.warning { background-color: #f39c12; }

        .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 8px; }
        .today-badge { background-color: #e8f6f3; color: #1abc9c; }
        .expired-badge { background-color: #fdedec; color: #e74c3c; }
        .future-badge { background-color: #ebf5fb; color: #3498db; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { display: flex; align-items: center; margin-bottom: 20px; }
        .modal-header i { font-size: 2rem; color: #e74c3c; margin-right: 15px; }
        .modal-header h3 { font-size: 1.5rem; color: #2c3e50; }
        .modal-body { margin-bottom: 25px; font-size: 1.1rem; line-height: 1.5; color: #555; }
        .modal-buttons { display: flex; gap: 15px; justify-content: flex-end; }
        .modal-cancel-btn { background-color: #95a5a6; color: white; padding: 12px 20px; }
        .modal-confirm-btn { background-color: #e74c3c; color: white; padding: 12px 20px; }
        .modal-cancel-btn:hover { background-color: #7f8c8d; }
        .modal-confirm-btn:hover { background-color: #c0392b; }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-boxes"></i> Escáner de Artículos</h1>
        <p class="subtitle">Registra artículos escaneados organizados por Caducidad, Clave y Cantidad</p>
    </header>

    <div class="container">
        <section class="scanner-section">
            <div class="scanner-header">
                <i class="fas fa-barcode"></i>
                <h2>Nuevo Escaneo</h2>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label for="caducidad-input"><i class="fas fa-calendar-day"></i> Caducidad (Mes)</label>
                    <select id="caducidad-input">
                        <option value="Enero">Enero</option>
                        <option value="Febrero">Febrero</option>
                        <option value="Marzo">Marzo</option>
                        <option value="Abril">Abril</option>
                        <option value="Mayo">Mayo</option>
                        <option value="Junio">Junio</option>
                        <option value="Julio" selected>Julio</option>
                        <option value="Agosto">Agosto</option>
                        <option value="Septiembre">Septiembre</option>
                        <option value="Octubre">Octubre</option>
                        <option value="Noviembre">Noviembre</option>
                        <option value="Diciembre">Diciembre</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="clave-input"><i class="fas fa-key"></i> Clave (Código)</label>
                    <input type="text" id="clave-input" placeholder="Ej: 123, ABC456, 789XYZ" autofocus>
                </div>

                <div class="input-group">
                    <label for="cantidad-input"><i class="fas fa-hashtag"></i> Cantidad</label>
                    <input type="number" id="cantidad-input" placeholder="Ej: 1, 5, 10" value="1" min="1">
                </div>
            </div>

            <div class="buttons">
                <button id="scan-btn" class="scan-btn" type="button">
                    <i class="fas fa-plus-circle"></i> Agregar Escaneo
                </button>
            </div>
        </section>

        <!-- Sección cámara -->
        <section class="scanner-section">
            <div class="scanner-header">
                <i class="fas fa-camera"></i>
                <h2>Escaneo con Cámara</h2>
            </div>

            <div class="buttons">
                <button id="camera-scan-btn" class="scan-btn" type="button">
                    <i class="fas fa-qrcode"></i> Iniciar Escaneo
                </button>
                <button id="camera-stop-btn" class="filter-btn" type="button">
                    <i class="fas fa-stop"></i> Detener
                </button>
            </div>

            <div style="margin-top: 15px;">
                <video id="camera-video" playsinline muted
                       style="width:100%; border-radius:10px; border:2px solid #eaeaea;"></video>
            </div>

            <p style="margin-top:10px; color:#666; font-size:0.95rem;">
                Consejo: usa buena luz. La app intenta usar la cámara trasera automáticamente.
            </p>
        </section>

        <section class="clear-all-section">
            <div class="clear-all-header">
                <i class="fas fa-exclamation-triangle"></i>
                <h2>Zona de Peligro</h2>
            </div>

            <div class="clear-all-warning">
                <p><i class="fas fa-exclamation-circle"></i> <strong>Advertencia:</strong> Esta acción eliminará todos los datos de escaneo permanentemente. No se puede deshacer.</p>
            </div>

            <button id="clear-all-btn" class="clear-all-btn" type="button">
                <i class="fas fa-trash-alt"></i> Limpiar Todos los Datos
            </button>
        </section>

        <section class="results-section">
            <div class="results-header">
                <h2><i class="fas fa-list-alt"></i> Resultados de Escaneo</h2>
                <div class="results-header-actions">
                    <button id="export-btn" class="export-btn" type="button">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-row">
                    <div class="filter-group">
                        <span class="filter-label">Filtrar por Clave:</span>
                        <input type="text" id="filter-clave" class="filter-input" placeholder="Ej: 123">
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">Filtrar por Caducidad:</span>
                        <select id="filter-caducidad" class="filter-input">
                            <option value="">Todos los meses</option>
                            <option value="Enero">Enero</option>
                            <option value="Febrero">Febrero</option>
                            <option value="Marzo">Marzo</option>
                            <option value="Abril">Abril</option>
                            <option value="Mayo">Mayo</option>
                            <option value="Junio">Junio</option>
                            <option value="Julio">Julio</option>
                            <option value="Agosto">Agosto</option>
                            <option value="Septiembre">Septiembre</option>
                            <option value="Octubre">Octubre</option>
                            <option value="Noviembre">Noviembre</option>
                            <option value="Diciembre">Diciembre</option>
                        </select>
                    </div>

                    <button id="filter-btn" class="filter-btn" type="button">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                    <button id="clear-filter-btn" class="filter-btn" type="button">
                        <i class="fas fa-times"></i> Limpiar Filtro
                    </button>
                </div>
            </div>

            <div id="results-container">
                <div class="empty-state">
                    <i class="fas fa-clipboard-list"></i>
                    <p>No hay artículos escaneados aún. Comienza a escanear para ver los resultados aquí.</p>
                </div>
            </div>

            <div class="summary">
                <div class="total-items">
                    Total de artículos escaneados: <span id="total-scans">0</span>
                </div>
                <div class="total-items">
                    Artículos diferentes: <span id="unique-items">0</span>
                </div>
                <div class="total-items">
                    Total unidades: <span id="total-units">0</span>
                </div>
            </div>
        </section>

        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> Instrucciones de uso</h3>
            <ul>
                <li>Selecciona la <strong>Caducidad</strong> (mes) en el combobox.</li>
                <li>Ingresa la <strong>Clave</strong> (código del artículo) o escanéala con la cámara.</li>
                <li>Especifica la <strong>Cantidad</strong> en el campo numérico (por defecto es 1).</li>
                <li>Haz clic en "Agregar Escaneo" o presiona Enter para registrar el artículo.</li>
                <li>Los resultados se mostrarán en una tabla de 3 columnas: Caducidad, Clave, Cantidad.</li>
                <li>Puedes filtrar los resultados por Clave o Caducidad usando los filtros superiores.</li>
                <li>Usa "Exportar" para descargar los resultados en formato CSV.</li>
                <li>La opción "Limpiar Todos los Datos" requiere confirmación.</li>
            </ul>
        </div>
    </div>

    <!-- Modal de confirmación para borrar todos los datos -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Confirmar Eliminación</h3>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que quiere borrar todos los datos? Esta acción no se puede deshacer y se perderán todos los registros de escaneo.</p>
            </div>
            <div class="modal-buttons">
                <button id="modal-cancel-btn" class="modal-cancel-btn" type="button">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button id="modal-confirm-btn" class="modal-confirm-btn" type="button">
                    <i class="fas fa-check"></i> Sí, Borrar Todo
                </button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text">Artículo agregado correctamente</span>
    </div>

    <script>
        // Datos de ejemplo
        const sampleData = [
            { caducidad: "Julio", clave: "123", cantidad: 3 },
            { caducidad: "Agosto", clave: "123", cantidad: 2 },
            { caducidad: "Julio", clave: "456", cantidad: 1 },
            { caducidad: "Agosto", clave: "456", cantidad: 4 },
            { caducidad: "Septiembre", clave: "789", cantidad: 2 },
            { caducidad: "Julio", clave: "ABC123", cantidad: 5 }
        ];

        // DOM
        const caducidadInput = document.getElementById('caducidad-input');
        const claveInput = document.getElementById('clave-input');
        const cantidadInput = document.getElementById('cantidad-input');
        const scanBtn = document.getElementById('scan-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const exportBtn = document.getElementById('export-btn');
        const filterClave = document.getElementById('filter-clave');
        const filterCaducidad = document.getElementById('filter-caducidad');
        const filterBtn = document.getElementById('filter-btn');
        const clearFilterBtn = document.getElementById('clear-filter-btn');
        const resultsContainer = document.getElementById('results-container');
        const totalScansElement = document.getElementById('total-scans');
        const uniqueItemsElement = document.getElementById('unique-items');
        const totalUnitsElement = document.getElementById('total-units');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        const confirmModal = document.getElementById('confirm-modal');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');

        // Filtros
        let currentFilterClave = "";
        let currentFilterCaducidad = "";

        // Cargar
        let items = JSON.parse(localStorage.getItem('scannerData')) || sampleData;

        function saveData() {
            localStorage.setItem('scannerData', JSON.stringify(items));
        }

        function showNotification(message, type = "success") {
            notificationText.textContent = message;
            notification.className = "notification";
            notification.classList.add("show");

            if (type === "error") notification.classList.add("error");
            else if (type === "warning") notification.classList.add("warning");

            setTimeout(() => notification.classList.remove("show"), 3000);
        }

        function addItem() {
            const caducidad = caducidadInput.value;
            const clave = claveInput.value.trim();
            const cantidad = parseInt(cantidadInput.value.trim(), 10);

            if (!caducidad) { showNotification("Por favor, selecciona una caducidad (mes)", "error"); caducidadInput.focus(); return; }
            if (!clave) { showNotification("Por favor, introduce una clave (código)", "error"); claveInput.focus(); return; }
            if (!cantidad || cantidad <= 0 || isNaN(cantidad)) { showNotification("Por favor, introduce una cantidad válida", "error"); cantidadInput.focus(); return; }

            items.push({ caducidad, clave, cantidad });
            saveData();
            updateResults();
            showNotification(`Artículo "${clave}" (${cantidad}) agregado para ${caducidad}`);

            claveInput.value = '';
            cantidadInput.value = '1';
            claveInput.focus();
        }

        function showConfirmModal() {
            if (items.length === 0) { showNotification("No hay datos para limpiar", "warning"); return; }
            confirmModal.style.display = "flex";
        }

        function closeConfirmModal() { confirmModal.style.display = "none"; }

        function clearAllData() {
            items = [];
            saveData();
            updateResults();
            showNotification("Todos los datos han sido eliminados", "warning");
            closeConfirmModal();
        }

        function processResults() {
            const groupedData = {};
            let totalUnits = 0;
            let uniqueItems = new Set();

            let filteredItems = items;

            if (currentFilterClave) {
                filteredItems = filteredItems.filter(item =>
                    item.clave.toLowerCase().includes(currentFilterClave.toLowerCase()));
            }
            if (currentFilterCaducidad) {
                filteredItems = filteredItems.filter(item =>
                    item.caducidad.toLowerCase() === currentFilterCaducidad.toLowerCase());
            }

            filteredItems.forEach(item => {
                const key = `${item.clave}|${item.caducidad}`;
                if (!groupedData[key]) groupedData[key] = { caducidad: item.caducidad, clave: item.clave, cantidad: 0 };
                groupedData[key].cantidad += item.cantidad;
                totalUnits += item.cantidad;
                uniqueItems.add(item.clave);
            });

            const results = Object.values(groupedData).sort((a, b) => {
                if (a.caducidad === b.caducidad) return a.clave.localeCompare(b.clave);
                const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
                const ai = months.indexOf(a.caducidad);
                const bi = months.indexOf(b.caducidad);
                if (ai !== -1 && bi !== -1) return ai - bi;
                return a.caducidad.localeCompare(b.caducidad);
            });

            return { results, totalScans: filteredItems.length, totalUnits, uniqueItems: uniqueItems.size };
        }

        function updateResults() {
            const { results, totalScans, totalUnits, uniqueItems } = processResults();

            totalScansElement.textContent = totalScans;
            totalUnitsElement.textContent = totalUnits;
            uniqueItemsElement.textContent = uniqueItems;

            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>${items.length === 0 ?
                            'No hay artículos escaneados aún. Comienza a escanear para ver los resultados aquí.' :
                            'No hay resultados que coincidan con los filtros aplicados.'}</p>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Caducidad (Mes)</th>
                            <th>Clave (Código)</th>
                            <th>Cantidad</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            results.forEach(item => {
                const currentMonth = new Date().toLocaleDateString('es-ES', { month: 'long' });
                const monthBadge = item.caducidad.toLowerCase() === String(currentMonth).toLowerCase()
                    ? '<span class="badge today-badge">Este mes</span>'
                    : '';

                tableHTML += `
                    <tr>
                        <td class="caducidad-cell">${item.caducidad} ${monthBadge}</td>
                        <td class="clave-cell">${item.clave}</td>
                        <td class="cantidad-cell">${item.cantidad}</td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            resultsContainer.innerHTML = tableHTML;
        }

        function applyFilters() {
            currentFilterClave = filterClave.value.trim();
            currentFilterCaducidad = filterCaducidad.value;
            updateResults();

            if (currentFilterClave || currentFilterCaducidad) {
                showNotification(`Filtros aplicados: ${currentFilterClave ? 'Clave: ' + currentFilterClave : ''} ${currentFilterCaducidad ? 'Caducidad: ' + currentFilterCaducidad : ''}`);
            }
        }

        function clearFilters() {
            filterClave.value = '';
            filterCaducidad.value = '';
            currentFilterClave = "";
            currentFilterCaducidad = "";
            updateResults();
            showNotification("Filtros limpiados");
        }

        function exportResults() {
            const { results } = processResults();
            if (results.length === 0) { showNotification("No hay datos para exportar", "error"); return; }

            let csvContent = "Caducidad,Clave,Cantidad\n";
            results.forEach(item => { csvContent += `"${item.caducidad}","${item.clave}",${item.cantidad}\n`; });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fecha = new Date().toISOString().split('T')[0];
            a.download = `escaneos_${fecha}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification("Resultados exportados a CSV correctamente");
        }

        // Eventos principales
        scanBtn.addEventListener('click', addItem);
        clearAllBtn.addEventListener('click', showConfirmModal);
        exportBtn.addEventListener('click', exportResults);
        filterBtn.addEventListener('click', applyFilters);
        clearFilterBtn.addEventListener('click', clearFilters);
        modalCancelBtn.addEventListener('click', closeConfirmModal);
        modalConfirmBtn.addEventListener('click', clearAllData);

        claveInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addItem(); });
        cantidadInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addItem(); });
        caducidadInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addItem(); });

        window.addEventListener('click', (e) => { if (e.target === confirmModal) closeConfirmModal(); });

        // --- Lector de códigos (ZXing) ---
        const cameraScanBtn = document.getElementById('camera-scan-btn');
        const cameraStopBtn = document.getElementById('camera-stop-btn');
        const cameraVideo = document.getElementById('camera-video');

        let codeReader = null;
        let cameraActive = false;

        async function startCameraScan() {
            if (cameraActive) return;

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification("Este dispositivo/navegador no soporta cámara.", "error");
                return;
            }

            try {
                cameraActive = true;

                const constraints = { video: { facingMode: { ideal: "environment" } }, audio: false };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);

                cameraVideo.srcObject = stream;
                await cameraVideo.play();

                showNotification("Cámara activa. Apunta al código...", "success");

                codeReader = new ZXing.BrowserMultiFormatReader();

                codeReader.decodeFromVideoElement(cameraVideo, (result, err) => {
                    if (result && result.text) {
                        const text = String(result.text).trim();
                        if (text) {
                            claveInput.value = text;
                            claveInput.focus();
                            showNotification(`Código detectado: ${text}`, "success");

                            // Para auto-agregar al detectar, descomenta:
                            // addItem();

                            stopCameraScan();
                        }
                    }
                });

            } catch (e) {
                cameraActive = false;
                showNotification("No se pudo abrir la cámara. Revisa permisos y HTTPS.", "error");
                console.error(e);
            }
        }

        function stopCameraScan() {
            if (!cameraActive) return;
            cameraActive = false;

            try { if (codeReader) codeReader.reset(); } catch {}

            const stream = cameraVideo.srcObject;
            if (stream && stream.getTracks) stream.getTracks().forEach(t => t.stop());
            cameraVideo.srcObject = null;

            showNotification("Cámara detenida.", "warning");
        }

        cameraScanBtn.addEventListener('click', startCameraScan);
        cameraStopBtn.addEventListener('click', stopCameraScan);

        document.addEventListener('visibilitychange', () => { if (document.hidden) stopCameraScan(); });

        // Inicializar
        updateResults();

        setTimeout(() => { if (items.length > 0) showNotification(`Cargados ${items.length} artículos existentes`); }, 1000);
    </script>

    <!-- Registrar Service Worker -->
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js").catch(console.error);
      }
    </script>
</body>
</html>
