<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Escáner de Artículos</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#2c3e50" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/@zxing/library@0.21.3"></script>

  <style>
    :root{
      --bg:#eef2f6;
      --card:#fff;
      --text:#253040;
      --muted:#6b7785;
      --primary:#2c3e50;
      --accent:#3498db;
      --ok:#2ecc71;
      --warn:#f39c12;
      --bad:#e74c3c;
      --border:#e3e9f0;
      --shadow:0 8px 22px rgba(18,38,63,.08);
      --radius:12px;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{background:var(--bg);color:var(--text);max-width:1080px;margin:0 auto;padding:14px;scroll-padding-top:90px}
    header{
      background:linear-gradient(135deg,#243243 0%,#2f4257 100%);
      color:#fff;border-radius:14px;box-shadow:var(--shadow);
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .h-left{display:flex;align-items:center;gap:12px}
    .h-left i{font-size:22px;color:#dce8f7}
    .h-left .t{font-size:20px;font-weight:900;letter-spacing:.2px}
    .h-right{font-size:12px;opacity:.9}
    .container{display:flex;flex-direction:column;gap:14px;margin-top:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:14px}
    .card-h{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:12px;
    }
    .card-h .ttl{display:flex;align-items:center;gap:10px;color:var(--primary);font-weight:950}
    .card-h .ttl i{color:var(--accent)}
    label{display:block;font-weight:800;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{
      width:100%;padding:12px 12px;border:1.8px solid #d4dde8;border-radius:10px;
      font-size:16px;outline:none;background:#fff;transition:.15s
    }
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(52,152,219,.18)}
    button{
      border:none;border-radius:10px;padding:12px 14px;font-weight:950;cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:.15s;user-select:none
    }
    .btn-ok{background:var(--ok);color:#fff}
    .btn-ok:hover{filter:brightness(.96);transform:translateY(-1px)}
    .btn-muted{background:#96a0a6;color:#fff}
    .btn-muted:hover{filter:brightness(.95);transform:translateY(-1px)}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-primary:hover{filter:brightness(.95);transform:translateY(-1px)}
    .btn-bad{background:var(--bad);color:#fff}
    .btn-bad:hover{filter:brightness(.95);transform:translateY(-1px)}
    .row{display:grid;grid-template-columns:220px 1fr 140px 240px;gap:12px;align-items:end}
    .row .btn-ok{width:100%}

    /* cámara layout como tu imagen */
    .cam-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;width:100%}
    .cam-actions .start{flex:1;min-width:220px}
    .cam-actions .stop{min-width:140px}
    .toggles{display:flex;gap:18px;flex-wrap:wrap;color:var(--muted);font-size:13px;margin-top:10px}
    .toggles label{display:flex;align-items:center;gap:8px;margin:0;font-weight:850;color:var(--muted)}
    .toggles input{width:auto;transform:scale(1.05)}
    .status{margin-top:10px;font-size:13px;color:var(--muted)}
    .video-wrap{
      width:100%;background:#000;border-radius:12px;border:1px solid var(--border);
      overflow:hidden;position:relative;margin-top:10px;aspect-ratio: 16/7;min-height:160px;
    }
    video{width:100%;height:100%;object-fit:cover;display:block}
    .scan-area{
      position:absolute;left:50%;top:50%;
      width:min(78%,520px);height:min(38%,180px);
      transform:translate(-50%,-50%);
      border:3px solid rgba(46,204,113,.95);
      border-radius:14px;
      box-shadow:0 0 0 9999px rgba(0,0,0,.25);
      pointer-events:none;
    }
    .scan-line{
      position:absolute;left:50%;top:50%;
      width:min(78%,520px);height:2px;
      transform:translate(-50%,-50%);
      background:rgba(46,204,113,.95);
      opacity:.85;pointer-events:none;
    }

    /* resultados */
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    .filters > div{min-width:220px}
    .actions-right{display:flex;gap:10px;flex-wrap:wrap}
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse;min-width:760px}
    th,td{padding:12px 10px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f7f9fb;font-weight:950;color:#1f2a37}
    .td-cad{font-weight:950;color:var(--bad)}
    .td-clave{font-weight:950}
    .td-name{color:var(--text);max-width:520px;}
    .td-cant{text-align:center;font-weight:950;color:var(--ok)}
    .summary{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-top:10px;color:var(--muted);font-weight:850}

    .danger{
      background:#fff7e6;border:1px solid rgba(243,156,18,.35);border-left:5px solid var(--warn);
      padding:12px;border-radius:12px;color:#5a4a10
    }

    /* toast */
    .toast{
      position:fixed;top:16px;right:16px;z-index:3000;
      background:var(--ok);color:#fff;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);
      display:flex;gap:10px;align-items:center;transform:translateX(140%);transition:.25s;
      max-width:min(92vw,520px)
    }
    .toast.show{transform:translateX(0)}
    .toast.bad{background:var(--bad)}
    .toast.warn{background:var(--warn)}

    /* modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:4000;align-items:center;justify-content:center}
    .modal .box{background:#fff;width:min(520px,92vw);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .modal .box h3{display:flex;align-items:center;gap:10px;color:var(--primary);margin-bottom:10px}
    .modal .box p{color:#4b5563;line-height:1.5;margin-bottom:14px}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}

    @media (max-width: 920px){ .row{grid-template-columns:1fr 1fr} }
    @media (max-width: 560px){ .row{grid-template-columns:1fr} .video-wrap{aspect-ratio:4/3} }
    
    /* --- v4.0.1 fixes: mobile layout + botones --- */
    @media (max-width: 560px){
      .filters > div{min-width:0 !important;flex:1 1 100%;}
      .cam-actions{flex-direction:column;align-items:stretch;}
      .cam-actions .stop,.cam-actions #btnTorch{width:100%;min-width:0 !important;}
    }
    @media (max-width: 420px){
      header{gap:8px !important;}
      .h-left .t{font-size:18px !important;}
      #btnMode{padding:8px 10px !important;border-radius:10px !important;font-size:12px !important;}
      .h-right > div{display:none;} /* oculta la leyenda larga en pantallas muy chicas */
    }

    .hidden{display:none !important;}
    .mode-pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);font-weight:900;font-size:12px;}

  
    /* v37 header compact */
    header{padding:10px 12px !important;border-radius:16px !important;}
    .h-left .brand{gap:10px !important;}
    .h-left .brand .logo{width:34px !important;height:34px !important;border-radius:12px !important;}
    .h-left .brand .name{font-size:22px !important;line-height:1 !important;}
    .h-left .brand .ver{font-size:12px !important;margin-top:2px !important;opacity:.85 !important;}
    #btnMode{padding:8px 10px !important;border-radius:12px !important;font-size:12px !important;gap:6px !important;min-height:34px !important;}
    #btnMode i{font-size:14px !important;}
    /* Auto layout tighter */
    #cameraCard .filters{margin:10px 0 12px !important;}
    #cameraCard .filters label{margin-bottom:6px !important;}
    #cameraCard .cam-actions{display:grid !important;grid-template-columns:1fr 1fr !important;gap:10px !important;margin-top:10px !important;}
    #cameraCard .cam-actions .btn{width:100% !important;}
    #cameraCard .toggles{display:grid !important;grid-template-columns:1fr 1fr !important;gap:10px 14px !important;margin-top:10px !important;}
    #cameraCard .toggles .ck{margin:0 !important;}
    #cameraCard .video-wrap{margin-top:6px !important;}
/* v38 mobile fixes */
    #cameraCard .cam-actions{grid-template-columns:minmax(0,1fr) minmax(0,1fr) !important;}
    #cameraCard .cam-actions .btn{min-width:0 !important;}
    @media (max-width: 420px){
      #cameraCard .cam-actions{grid-template-columns:1fr !important;}
      #cameraCard .cam-actions .btn{width:100% !important;}
    }

    /* v39 camera layout */
    #cameraCard .cam-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    #cameraCard .cam-actions button{width:100%;}
    #cameraCard .toggles{display:grid;grid-template-columns:1fr 1fr;gap:10px 14px;}
    #cameraCard .toggles label{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--muted);}
    #cameraCard .toggles input{width:18px;height:18px;}
    @media (max-width:380px){
      #cameraCard .cam-actions{grid-template-columns:1fr;}
      #cameraCard .toggles{grid-template-columns:1fr;}
    }

    /* v40 catalog */
    #catalogCard input[type="file"]{
      width:100%;
      padding:10px 12px;
      border:1px dashed rgba(255,255,255,.25);
      border-radius:12px;
      background:rgba(255,255,255,.06);
      color:var(--text);
    }
    #catalogInfo{font-size:12px;opacity:.9;}

  /* --- Edit modal --- */
  .modal-edit{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:9999;padding:16px;}
  .modal-edit .box{background:#fff;border-radius:18px;max-width:520px;width:100%;padding:16px;box-shadow:0 18px 50px rgba(0,0,0,.25);}
  .modal-edit .mh{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;}
  .modal-edit .mh .t{font-weight:950;font-size:16px;}
  .modal-edit .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;}
  .modal-edit .grid .full{grid-column:1 / -1;}
  .modal-edit label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;}
  .modal-edit input,.modal-edit select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-weight:800;}
  .modal-edit .row{display:flex;gap:10px;margin-top:14px;}
  .modal-edit .row button{flex:1;}
  @media (max-width:520px){ .modal-edit .grid{grid-template-columns:1fr;} }
  .btn-mini{padding:8px 10px;border-radius:12px;font-weight:900;}

</style>
</head>
<body>
  <header>
    <div class="h-left">
      <i class="fa-solid fa-boxes-stacked"></i>
      <div>
        <div class="t">Escáner de Artículos</div>
        <div style="font-size:12px;opacity:.86;">Versión 4.0</div>
      </div>
    </div>
    <div class="h-right" style="display:flex;align-items:center;gap:10px;"><div style="opacity:.9;font-size:12px;">Caducidad + Clave + Cantidad</div><button id="btnMode" class="btn-primary" type="button" style="padding:10px 12px;border-radius:12px;font-size:12px;white-space:nowrap;"><i class="fa-solid fa-toggle-on"></i> Automático</button></div>
  </header>

  <div class="container">
<section class="card" id="manualCard">
      <div class="row">
        <div>
          <label>Caducidad (Mes)</label>
          <select id="caducidad">
            <option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option><option>Mayo</option><option>Junio</option>
            <option selected>Julio</option><option>Agosto</option><option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
          </select>
        </div>
        <div>
          <label>Clave (Código)</label>
          <input id="clave" placeholder="Ej: 750... / CODE128 / ITF" autocomplete="off" / enterkeyhint="done" autocapitalize="off" autocorrect="off" spellcheck="false" inputmode="numeric" pattern="[0-9]*" enterkeyhint="done" autocapitalize="off" autocorrect="off" spellcheck="false">
        </div>
        <div>
          <label>Cantidad</label>
          <input id="cantidad" type="number" value="1" min="1" />
        </div>
        <div>
          <label style="visibility:hidden">Acción</label>
          <button class="btn-ok" id="btnAgregar" type="button"><i class="fa-solid fa-circle-plus"></i> Agregar Escaneo</button>
        </div>
      </div>
      <canvas id="scanCanvas" style="display:none;"></canvas>
    </section>

    <section class="card" id="cameraCard">
      <div class="card-h">
        <div class="ttl"><i class="fa-solid fa-camera"></i> Escaneo con Cámara</div>
      </div>

      <div class="video-wrap">
        <video id="video" playsinline muted></video>
        <div class="scan-area"></div>
        <div class="scan-line"></div>
      </div>

      <div class="filters auto-month" style="margin-top:12px;">
        <div style="flex:1;min-width:220px;">
          <label>Caducidad (Mes)</label>
          <select id="caducidadAuto">
            <option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option><option>Mayo</option><option>Junio</option>
            <option>Julio</option><option>Agosto</option><option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
          </select>
        </div>
      </div>

      <button class="btn-ok start" id="btnCamStart" type="button" style="margin-top:12px;width:100%;">
        <i class="fa-solid fa-qrcode"></i> Iniciar Escaneo
      </button>

      <div class="cam-actions" style="margin-top:10px;">
        <button class="btn-muted stop" id="btnCamStop" type="button"><i class="fa-solid fa-stop"></i> Detener</button>
        <button class="btn-primary" id="btnTorch" type="button" style="display:none;"><i class="fa-solid fa-lightbulb"></i> Luz</button>
      </div>

      <div class="toggles" style="margin-top:12px;">
        <label><input id="optAuto" type="checkbox" checked> Auto-agregar al detectar</label>
        <label><input id="optSound" type="checkbox" checked> Sonido</label>
        <label><input id="optVib" type="checkbox" checked> Vibración</label>
      </div>

      <div class="status" style="margin-top:10px;">
        Estado: <strong id="camStatus">detenido</strong> &nbsp;&nbsp;|&nbsp;&nbsp;
        Último: <strong id="lastCode">—</strong>
      </div>
    </section>

    <section class="card">
      <div class="card-h">
        <div class="ttl"><i class="fa-solid fa-list-check"></i> Resultados de Escaneo</div>
        <div class="actions-right">
          <button class="btn-primary" id="btnExport" type="button"><i class="fa-solid fa-file-arrow-down"></i> Exportar CSV</button>
        </div>
      </div>

      <div class="filters">
        <div>
          <label>Filtrar por Clave</label>
          <input id="fClave" placeholder="Ej: 750" />
        </div>
        <div>
          <label>Filtrar por Mes</label>
          <select id="fCad">
            <option value="">Todos</option>
            <option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option><option>Mayo</option><option>Junio</option>
            <option>Julio</option><option>Agosto</option><option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
          </select>
        </div>
        <div style="min-width:auto;">
          <label style="visibility:hidden">Acción</label>
          <button class="btn-muted" id="btnFiltrar" type="button"><i class="fa-solid fa-filter"></i> Filtrar</button>
        </div>
        <div style="min-width:auto;">
          <label style="visibility:hidden">Acción</label>
          <button class="btn-muted" id="btnLimpiarFiltro" type="button"><i class="fa-solid fa-xmark"></i> Limpiar Filtro</button>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:10px;">
        <div id="tablaWrap" style="min-height:160px;"></div>
      </div>

      <div class="summary">
        <div>Total de escaneos: <strong id="sumScans">0</strong></div>
        <div>Claves diferentes: <strong id="sumUnique">0</strong></div>
        <div>Total unidades: <strong id="sumUnits">0</strong></div>
      </div>
    </section>

    <section class="card">
      <div class="card-h">
        <div class="ttl"><i class="fa-solid fa-triangle-exclamation" style="color:var(--warn)"></i> Zona de Peligro</div>
      </div>
      <div class="danger">
        <strong>Advertencia:</strong> Esta acción elimina todos los datos guardados en el dispositivo.
      </div>
      <div style="margin-top:12px;">
        <button class="btn-bad" id="btnClearAll" type="button" style="width:100%;"><i class="fa-solid fa-trash"></i> Limpiar Todos los Datos</button>
      </div>
    </section>
  </div>

  <div id="toast" class="toast"><i class="fa-solid fa-circle-check"></i><div id="toastMsg" style="font-weight:950;">OK</div></div>



    
    <section class="card" id="catalogCard">
      <div class="card-h">
        <div class="ttl"><i class="fa-solid fa-book"></i> Catálogo (CSV)</div>
        <div class="hint" id="catalogInfo">Sin catálogo cargado</div>
      </div>

      <div class="filters" style="gap:12px;align-items:end;">
        <div style="flex:1;min-width:220px;">
          <label>Importar CSV</label>
          <input id="catalogFile" type="file" accept=".csv,text/csv" />
          <div class="hint" style="margin-top:6px;">El CSV debe tener una columna de <b>código</b> y una de <b>nombre</b>. Se detecta automáticamente (code/barcode/clave y nombre/descripcion).</div>
        </div>
        <button class="btn-primary" id="btnClearCatalog" type="button" style="min-width:170px;">
          <i class="fa-solid fa-trash"></i> Borrar catálogo
        </button>
      </div>

      <div class="status" style="margin-top:10px;">
        Escaneado: <b id="scanName">—</b>
      </div>
    </section>


  <div id="modal" class="modal">
    <div class="box">
      <h3><i class="fa-solid fa-triangle-exclamation" style="color:var(--bad)"></i> Confirmar Eliminación</h3>
      <p>¿Seguro que quieres borrar todos los datos? No se puede deshacer.</p>
      <div class="actions">
        <button class="btn-muted" id="btnCancel" type="button"><i class="fa-solid fa-xmark"></i> Cancelar</button>
        <button class="btn-bad" id="btnConfirm" type="button"><i class="fa-solid fa-check"></i> Sí, Borrar</button>
      </div>
    </div>
  </div>

  <script>
    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');
    let toastT = null;
    function notify(msg, type='ok'){
      toastMsg.textContent = msg;
      toast.className = 'toast show' + (type==='bad' ? ' bad' : type==='warn' ? ' warn' : '');
      clearTimeout(toastT);
      toastT = setTimeout(()=>toast.classList.remove('show'), 1600);
    }

    const optSound = document.getElementById('optSound');
    const optVib = document.getElementById('optVib');
    const optAuto = document.getElementById('optAuto');

    let audioCtx = null;
    function unlockAudio(){
      try{
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
      }catch(e){}
    }
    function beep(){
      if (!optSound.checked) return;
      try{
        unlockAudio();
        if (!audioCtx) return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine';
        o.frequency.value = 880;
        g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.25, audioCtx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.12);
        o.connect(g); g.connect(audioCtx.destination);
        o.start();
        o.stop(audioCtx.currentTime + 0.13);
      }catch(e){}
    }
    function vibrate(){ if (optVib.checked && navigator.vibrate) navigator.vibrate(100); }

    function loadPrefs(){
      const p = JSON.parse(localStorage.getItem('scannerPrefs') || '{}');
      optAuto.checked = p.auto !== false;
      optSound.checked = p.sound !== false;
      optVib.checked = p.vib !== false;
    }
    function savePrefs(){
      localStorage.setItem('scannerPrefs', JSON.stringify({ auto: optAuto.checked, sound: optSound.checked, vib: optVib.checked }));
    }
    optAuto.addEventListener('change', savePrefs);
    optSound.addEventListener('change', savePrefs);
    optVib.addEventListener('change', savePrefs);
    loadPrefs();

    // ===== Catálogo CSV =====
    const catalogFile = document.getElementById('catalogFile');
    const btnClearCatalog = document.getElementById('btnClearCatalog');
    const catalogInfo = document.getElementById('catalogInfo');
    const scanNameEl = document.getElementById('scanName');

    let catalogMap = {};
    try{ catalogMap = JSON.parse(localStorage.getItem('scannerCatalog') || '{}') || {}; }catch(e){ catalogMap = {}; }

    function catalogCount(){ return Object.keys(catalogMap).length; }

    function setCatalogInfo(){
      const n = catalogCount();
      if (catalogInfo) catalogInfo.textContent = n ? `Cargado: ${n} artículos` : 'Sin catálogo cargado';
    }

    function normalizeCandidates(code){
      const raw = String(code||'').trim();
      const candidates = new Set();
      if (!raw) return [];
      candidates.add(raw);

      const digits = raw.replace(/\D+/g,'');
      if (digits) candidates.add(digits);
      if (digits) candidates.add(digits.replace(/^0+/, ''));
      if (digits.length === 13 && digits.startsWith('0')) candidates.add(digits.slice(1));
      if (digits.length === 12) candidates.add('0'+digits);
      return Array.from(candidates).filter(Boolean);
    }

    function lookupName(code){
      const cands = normalizeCandidates(code);
      for (const c of cands){
        if (catalogMap[c]) return catalogMap[c];
      }
      return '';
    }

    function showScanName(code){
      if (!scanNameEl) return;
      const name = lookupName(code);
      scanNameEl.textContent = name ? name : 'No encontrado en catálogo';
    }

    function splitCSVLine(line){
      const out = [];
      let cur = '';
      let inQ = false;
      for (let i=0;i<line.length;i++){
        const ch = line[i];
        if (ch === '"'){
          if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
          else inQ = !inQ;
        }else if (ch === ',' && !inQ){
          out.push(cur);
          cur = '';
        }else{
          cur += ch;
        }
      }
      out.push(cur);
      return out.map(s=>s.trim());
    }

    function detectColumns(headers){
      const h = headers.map(x=>String(x||'').toLowerCase().trim());
      const findAny = (keys)=> h.findIndex(v=>keys.some(k=>v===k || v.includes(k)));
      const codeIdx = findAny(['barcode','bar code','código','codigo','clave','code','sku','ean','upc']);
      const nameIdx = findAny(['nombre','name','descripcion','descripción','producto','articulo','artículo','item']);
      return { codeIdx, nameIdx };
    }

    function parseCatalogCSV(text){
      const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim().length);
      if (!lines.length) return {map:{}, rows:0};

      const first = splitCSVLine(lines[0]);
      let codeIdx = 0, nameIdx = 1, startRow = 0;

      const maybeHeader = first.some(x => /[a-zA-ZáéíóúñÁÉÍÓÚÑ]/.test(x));
      if (maybeHeader){
        const det = detectColumns(first);
        if (det.codeIdx !== -1) codeIdx = det.codeIdx;
        if (det.nameIdx !== -1) nameIdx = det.nameIdx;
        startRow = 1;
      }

      const map = {};
      let rows = 0;

      for (let i=startRow;i<lines.length;i++){
        const cols = splitCSVLine(lines[i]);
        if (!cols.length) continue;
        const code = (cols[codeIdx] ?? '').trim();
        const name = (cols[nameIdx] ?? '').trim();
        if (!code || !name) continue;
        map[code] = name;
        rows++;
      }
      return {map, rows};
    }

    async function handleCatalogFile(file){
      const text = await file.text();
      const {map, rows} = parseCatalogCSV(text);
      if (!rows){
        notify('No se detectaron filas válidas en el CSV', 'bad');
        return;
      }
      catalogMap = map;
      try{ localStorage.setItem('scannerCatalog', JSON.stringify(catalogMap)); }catch(e){
        notify('Catálogo demasiado grande para guardar. Reduce filas/columnas.', 'bad');
      }
      setCatalogInfo();
      notify(`Catálogo cargado: ${rows} artículos`, 'ok');
    }

    if (catalogFile){
      catalogFile.addEventListener('change', async (e)=>{
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        try{ await handleCatalogFile(f); }catch(err){ notify('Error leyendo CSV', 'bad'); }
        catalogFile.value = '';
      });
    }

    if (btnClearCatalog){
      btnClearCatalog.addEventListener('click', ()=>{
        catalogMap = {};
        localStorage.removeItem('scannerCatalog');
        setCatalogInfo();
        if (scanNameEl) scanNameEl.textContent = '—';
        notify('Catálogo borrado', 'warn');
      });
    }



    const manualCard = document.getElementById('manualCard');
    const cameraCard = document.getElementById('cameraCard');
    const btnMode = document.getElementById('btnMode');

    // uiMode: 'manual' o 'auto'
    let uiMode = localStorage.getItem('scannerUIMode') || 'manual';

    function applyMode(){
      const isAuto = (uiMode === 'auto');
      if (manualCard) manualCard.classList.toggle('hidden', isAuto);
      if (cameraCard) cameraCard.classList.toggle('hidden', !isAuto);

      if (btnMode){
        btnMode.innerHTML = isAuto
          ? '<i class="fa-solid fa-keyboard"></i> Manual'
          : '<i class="fa-solid fa-camera"></i> Automático';
        btnMode.className = isAuto ? 'btn-muted' : 'btn-primary';
      }

      // Para que no brinque: en modo auto, evitamos foco y teclado
      if (isAuto){
        try{ syncCaducidadToAuto(); }catch(e){}
        try{ claveEl.blur(); }catch(e){}
      }else{
        stopCam();
        // en manual sí enfocamos
        setTimeout(()=>{ try{ claveEl.focus(); }catch(e){} }, 120);
      }
      localStorage.setItem('scannerUIMode', uiMode);
    }

    if (btnMode){
      btnMode.addEventListener('click', ()=>{
        uiMode = (uiMode === 'manual') ? 'auto' : 'manual';
        applyMode();
      });
    }



    const caducidadEl = document.getElementById('caducidad');
    const caducidadAutoEl = document.getElementById('caducidadAuto');
    const claveEl = document.getElementById('clave');
    const cantidadEl = document.getElementById('cantidad');
    const btnAgregar = document.getElementById('btnAgregar');

    const fClave = document.getElementById('fClave');
    const fCad = document.getElementById('fCad');
    const btnFiltrar = document.getElementById('btnFiltrar');
    const btnLimpiarFiltro = document.getElementById('btnLimpiarFiltro');
    const tablaWrap = document.getElementById('tablaWrap');

    const sumScans = document.getElementById('sumScans');
    const sumUnique = document.getElementById('sumUnique');
    const sumUnits = document.getElementById('sumUnits');

    let items = JSON.parse(localStorage.getItem('scannerData') || 'null') || [];
    let curFilterClave = '';
    let curFilterCad = '';

    function syncCaducidadToAuto(){
      if (!caducidadAutoEl || !caducidadEl) return;
      caducidadAutoEl.value = caducidadEl.value;
    }
    function syncCaducidadToManual(){
      if (!caducidadAutoEl || !caducidadEl) return;
      caducidadEl.value = caducidadAutoEl.value;
    }
    if (caducidadEl) caducidadEl.addEventListener('change', syncCaducidadToAuto);
    if (caducidadAutoEl) caducidadAutoEl.addEventListener('change', ()=>{
      syncCaducidadToManual();
      notify('Mes actualizado', 'ok');
    });


    function saveData(){ localStorage.setItem('scannerData', JSON.stringify(items)); }
    function escapeHtml(s){
      return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return String(s??'').replaceAll('&','&amp;').replaceAll('"','&quot;').replaceAll("'",'&#39;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }


    
    function addItemDirect(code, {silent=false} = {}){
      const cad = caducidadEl.value;
      const clave = String(code || '').trim();
      const cant = parseInt((cantidadEl.value || '0'), 10);

      if (!cad){ if(!silent) notify('Selecciona caducidad', 'bad'); return false; }
      if (!clave){ if(!silent) notify('Código vacío', 'bad'); return false; }
      if (!cant || isNaN(cant) || cant <= 0){ if(!silent) notify('Cantidad inválida', 'bad'); return false; }

      items.push({ caducidad: cad, clave, nombre: (lookupName(clave)||''), cantidad: cant });
      saveData();
      render();
      beep(); vibrate();

      // En modo cámara NO movemos foco ni limpiamos para evitar brincos
      if(!silent) notify('Agregado', 'ok');
      return true;
    }

function addItemFromInputs({silent=false} = {}){
      const cad = caducidadEl.value;
      const clave = (claveEl.value || '').trim();
      const cant = parseInt((cantidadEl.value || '0'), 10);

      if (!cad){ if(!silent) notify('Selecciona caducidad', 'bad'); return false; }
      if (!clave){ if(!silent) notify('Introduce clave', 'bad'); return false; }
      if (!cant || isNaN(cant) || cant <= 0){ if(!silent) notify('Cantidad inválida', 'bad'); return false; }

      items.push({ caducidad: cad, clave, nombre: (lookupName(clave)||''), cantidad: cant });
      saveData();
      render();
      beep(); vibrate();

      claveEl.value = '';
      cantidadEl.value = '1';
      claveEl.focus();

      if(!silent) notify('Agregado', 'ok');
      return true;
    }

    function process(){
      let filtered = items.slice();
      if (curFilterClave) filtered = filtered.filter(i => i.clave.toLowerCase().includes(curFilterClave.toLowerCase()));
      if (curFilterCad) filtered = filtered.filter(i => i.caducidad.toLowerCase() === curFilterCad.toLowerCase());

      const grouped = {};
      let units = 0;
      const uniq = new Set();

      for (const it of filtered){
        const k = it.clave + '|' + it.caducidad;
        if (!grouped[k]) grouped[k] = { caducidad: it.caducidad, clave: it.clave, nombre: '', cantidad: 0 };
        grouped[k].cantidad += it.cantidad;
        if (!grouped[k].nombre){
          const n = (it.nombre || lookupName(it.clave) || '').trim();
          if (n) grouped[k].nombre = n;
        }
        units += it.cantidad;
        uniq.add(it.clave);
      }

      const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
      const results = Object.values(grouped).sort((a,b) => {
        if (a.caducidad === b.caducidad) return a.clave.localeCompare(b.clave);
        return months.indexOf(a.caducidad) - months.indexOf(b.caducidad);
      });

      return { results, scans: filtered.length, uniq: uniq.size, units };
    }

    function render(){
      const { results, scans, uniq, units } = process();
      sumScans.textContent = scans;
      sumUnique.textContent = uniq;
      sumUnits.textContent = units;

      if (!results.length){
        tablaWrap.innerHTML = `
          <div style="padding:26px; text-align:center; color:var(--muted);">
            <i class="fa-regular fa-clipboard" style="font-size:34px; opacity:.5;"></i>
            <div style="margin-top:10px; font-weight:950;">${items.length ? 'No hay resultados con filtros.' : 'No hay artículos aún.'}</div>
          </div>`;
        return;
      }

      let html = `<table><thead><tr><th>Mes</th><th>Clave</th><th>Nombre</th><th style="text-align:center;">Cantidad</th><th style="text-align:center; width:70px;">Editar</th></tr></thead><tbody>`;
      for (const r of results){
        html += `<tr>
          <td class="td-cad">${r.caducidad}</td>
          <td class="td-clave">${escapeHtml(r.clave)}</td>
          <td class="td-name">${escapeHtml(r.nombre || '')}</td>
          <td class="td-cant">${r.cantidad}</td>
          <td style="text-align:center;">
            <button class="btn-muted btn-mini" type="button" data-act="edit" data-clave="${escapeAttr(r.clave)}" data-mes="${escapeAttr(r.caducidad)}">
              <i class="fa-solid fa-pen-to-square"></i>
            </button>
          </td>
        </tr>`;
      }
      html += `</tbody></table>`;
      tablaWrap.innerHTML = html;
    }

    // --- Editar registro (por Mes + Clave, basado en la tabla agrupada) ---
    const editModal = document.getElementById('editModal');
    const editClave = document.getElementById('editClave');
    const editNombre = document.getElementById('editNombre');
    const editMes = document.getElementById('editMes');
    const editCantidad = document.getElementById('editCantidad');
    const btnEditClose = document.getElementById('btnEditClose');
    const btnEditCancel = document.getElementById('btnEditCancel');
    const btnEditSave = document.getElementById('btnEditSave');

    let editCtx = null; // {clave, mes}

    function openEditModal(clave, mes){
      const { results } = process();
      const row = results.find(r => String(r.clave)===String(clave) && String(r.caducidad)===String(mes));
      if (!row){ notify('No se encontró el registro', 'bad'); return; }

      editCtx = { clave: String(clave), mes: String(mes) };
      editClave.value = row.clave;
      editNombre.value = row.nombre || (lookupName(row.clave) || '');
      editMes.value = row.caducidad;
      editCantidad.value = String(row.cantidad);

      editModal.style.display = 'flex';
      editModal.setAttribute('aria-hidden','false');
      setTimeout(()=>{ try{ editCantidad.focus(); editCantidad.select(); }catch(e){} }, 60);
    }

    function closeEditModal(){
      editModal.style.display = 'none';
      editModal.setAttribute('aria-hidden','true');
      editCtx = null;
    }

    if (btnEditClose) btnEditClose.addEventListener('click', closeEditModal);
    if (btnEditCancel) btnEditCancel.addEventListener('click', closeEditModal);
    if (editModal){
      editModal.addEventListener('click', (e)=>{ if (e.target === editModal) closeEditModal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && editModal.style.display==='flex') closeEditModal(); });
    }

    if (tablaWrap){
      tablaWrap.addEventListener('click', (e)=>{
        const b = e.target.closest('[data-act="edit"]');
        if (!b) return;
        openEditModal(b.getAttribute('data-clave')||'', b.getAttribute('data-mes')||'');
      });
    }

    if (btnEditSave){
      btnEditSave.addEventListener('click', ()=>{
        if (!editCtx) return;
        const newMes = (editMes.value || '').trim();
        const rawQty = Number(editCantidad.value);
        const newQty = Number.isFinite(rawQty) ? Math.max(0, Math.floor(rawQty)) : 0;

        const oldClave = editCtx.clave;
        const oldMes = editCtx.mes;

        // Mantener nombre (o resolver de catálogo)
        const name = (editNombre.value || lookupName(oldClave) || '').trim();

        // Eliminar todas las entradas que componen ese grupo (clave+mes)
        items = items.filter(it => !(String(it.clave)===String(oldClave) && String(it.caducidad)===String(oldMes)));

        // Reinsertar si qty > 0
        if (newQty > 0){
          items.push({
            caducidad: newMes || oldMes,
            clave: oldClave,
            nombre: name,
            cantidad: newQty,
            t: Date.now()
          });
        }

        localStorage.setItem('scannerData', JSON.stringify(items));
        render();
        closeEditModal();
        notify(newQty>0 ? 'Registro actualizado' : 'Registro eliminado', newQty>0 ? 'ok' : 'warn');
      });
    }

    btnAgregar.addEventListener('click', ()=>{ unlockAudio(); addItemFromInputs(); });
    claveEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ unlockAudio(); addItemFromInputs(); } });
    // Muchos lectores físicos envían ENTER al final. Si el foco está en Clave, agregamos.
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && document.activeElement === claveEl){
        e.preventDefault();
        unlockAudio();
        addItemFromInputs();
      }
    });


    btnFiltrar.addEventListener('click', ()=>{
      curFilterClave = (fClave.value||'').trim();
      curFilterCad = fCad.value || '';
      render();
      notify('Filtro aplicado', 'ok');
    });
    btnLimpiarFiltro.addEventListener('click', ()=>{
      fClave.value=''; fCad.value='';
      curFilterClave=''; curFilterCad='';
      render();
      notify('Filtro limpiado', 'ok');
    });

    document.getElementById('btnExport').addEventListener('click', ()=>{
      const { results } = process();
      if (!results.length){ notify('No hay datos para exportar', 'bad'); return; }
      let csv = "Mes,Clave,Nombre,Cantidad
";
      for (const r of results){
        csv += `"${r.caducidad}","${String(r.clave).replaceAll('"','""')}","${String(r.nombre||'').replaceAll('"','""')}",${r.cantidad}
`;
      }
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `escaneos_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      notify('CSV descargado', 'ok');
    });

    const modal = document.getElementById('modal');
    document.getElementById('btnClearAll').addEventListener('click', ()=>{
      if (!items.length){ notify('No hay datos', 'warn'); return; }
      modal.style.display='flex';
    });
    document.getElementById('btnCancel').addEventListener('click', ()=> modal.style.display='none');
    document.getElementById('btnConfirm').addEventListener('click', ()=>{
      items = [];
      saveData();
      render();
      modal.style.display='none';
      notify('Datos eliminados', 'warn');
    });
    modal.addEventListener('click', (e)=>{ if(e.target === modal) modal.style.display='none'; });

    // Cámara
    const btnCamStart = document.getElementById('btnCamStart');
    const btnCamStop = document.getElementById('btnCamStop');
    const btnTorch = document.getElementById('btnTorch');
    const video = document.getElementById('video');
    const camStatus = document.getElementById('camStatus');
    const lastCode = document.getElementById('lastCode');

    let codeReader = null;
    let lastScanTs = 0;
    let lastScanText = '';
    const SCAN_COOLDOWN_MS = 650;
    const SCAN_LOCK_MS = 900; // evita lecturas repetidas en ráfaga
    let scanLockUntil = 0; // evita doble lectura

    let controls = null;
    let cameraActive = false;
    let torchOn = false;

    function setStatus(s){ camStatus.textContent = s; }
    function getRoiRect(){
      const area = document.querySelector('.scan-area');
      const r = area.getBoundingClientRect();
      const vr = video.getBoundingClientRect();
      const x = (r.left - vr.left) / vr.width;
      const y = (r.top - vr.top) / vr.height;
      const w = r.width / vr.width;
      const h = r.height / vr.height;
      return {x, y, w, h};
    }
    function inRoiFromResult(result){
      const pts = result.resultPoints || (result.getResultPoints && result.getResultPoints()) || [];
      if (!pts || !pts.length) return true;
      const vw = video.videoWidth || 0;
      const vh = video.videoHeight || 0;
      if (!vw || !vh) return true;

      let minX=1e9, minY=1e9, maxX=-1e9, maxY=-1e9;
      for (const p of pts){
        const x = (p && (p.x ?? (p.getX && p.getX()))) ?? 0;
        const y = (p && (p.y ?? (p.getY && p.getY()))) ?? 0;
        minX = Math.min(minX, x); minY = Math.min(minY, y);
        maxX = Math.max(maxX, x); maxY = Math.max(maxY, y);
      }
      const cx = (minX + maxX) / 2;
      const cy = (minY + maxY) / 2;
      const nx = cx / vw;
      const ny = cy / vh;

      const roi = getRoiRect();
      const pad = 0.03;
      return (nx >= roi.x - pad && nx <= roi.x + roi.w + pad && ny >= roi.y - pad && ny <= roi.y + roi.h + pad);
    }


    async function applyTrackTweaks(track){
      try{
        const caps = track.getCapabilities ? track.getCapabilities() : null;
        if (!caps) return;
        if (caps.torch) btnTorch.style.display = 'inline-flex';

        const adv = [];
        if (caps.focusMode && caps.focusMode.includes('continuous')) adv.push({ focusMode: 'continuous' });
        if (caps.exposureMode && caps.exposureMode.includes('continuous')) adv.push({ exposureMode: 'continuous' });
        if (caps.whiteBalanceMode && caps.whiteBalanceMode.includes('continuous')) adv.push({ whiteBalanceMode: 'continuous' });
        if (caps.zoom){
          const z = Math.min(caps.zoom.max ?? 2, 2);
          const z2 = Math.max(caps.zoom.min ?? 1, z);
          adv.push({ zoom: z2 });
        }
        if (adv.length) await track.applyConstraints({ advanced: adv });
      }catch(e){}
    }

    async function toggleTorch(){
      try{
        const stream = video.srcObject;
        if (!stream) return;
        const track = stream.getVideoTracks()[0];
        const caps = track.getCapabilities ? track.getCapabilities() : null;
        if (!caps || !caps.torch) return;
        torchOn = !torchOn;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        notify(torchOn ? 'Luz encendida' : 'Luz apagada', 'ok');
      }catch(e){
        notify('Tu cámara no permite luz', 'warn');
      }
    }

    async function startCam(){
      if (cameraActive) return;
      unlockAudio();

      // Requiere HTTPS (GitHub Pages OK). En HTTP la cámara no funciona.
      cameraActive = true;
      setStatus('iniciando...');

      try{
        const constraints = {
          audio: false,
          video: { facingMode: { ideal: "environment" }, width: { ideal: 1920 }, height: { ideal: 1080 } }
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();

        // Ajustes de enfoque/zoom/torch si están disponibles
        const track = stream.getVideoTracks()[0];
        if (track) {
          await applyTrackTweaks(track);
          try{
            const caps = track.getCapabilities ? track.getCapabilities() : null;
            if (caps && caps.torch) btnTorch.style.display = 'inline-flex';
          }catch(e){}
        }

        // BarcodeDetector nativo (rápido). Fallback a ZXing si no existe.
        const supportsNative = ('BarcodeDetector' in window);
        let detector = null;
        if (supportsNative){
          try{
            detector = new BarcodeDetector({
              formats: ['ean_13','ean_8','upc_a','upc_e','code_128','code_39','itf','qr_code']
            });
          }catch(e){
            detector = new BarcodeDetector(); // algunos dispositivos ignoran formats
          }
        }

        const canvas = document.getElementById('scanCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });

        let running = true;
        setStatus('escaneando');

        // Evitar 'brinco' por ajustes del navegador al actualizar UI
        let lockedScrollY = window.scrollY;
        const lockScroll = ()=>{ if (uiMode === 'auto') window.scrollTo(0, lockedScrollY); };


        const loop = async ()=>{
          if (!cameraActive || !running) return;

          // Lock temporal para evitar dobles lecturas
          if (Date.now() < scanLockUntil){ requestAnimationFrame(loop); return; }

          // throttle por tiempo para no saturar CPU
          const now = Date.now();
          if (now - lastScanTs < 80){ requestAnimationFrame(loop); return; }

          const vw = video.videoWidth || 0;
          const vh = video.videoHeight || 0;
          if (!vw || !vh){ requestAnimationFrame(loop); return; }

          // ROI en pixeles del video: recortamos para detectar más rápido
          const roi = getRoiRect();
          const sx = Math.max(0, Math.floor(roi.x * vw));
          const sy = Math.max(0, Math.floor(roi.y * vh));
          const sw = Math.min(vw - sx, Math.floor(roi.w * vw));
          const sh = Math.min(vh - sy, Math.floor(roi.h * vh));

          // canvas del tamaño del ROI
          canvas.width = Math.max(1, sw);
          canvas.height = Math.max(1, sh);

          ctx.drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);

          try{
            let codeText = '';

            if (detector){
              const codes = await detector.detect(canvas);
              if (codes && codes.length){
                codeText = String(codes[0].rawValue || '').trim();
              }
            } else if (window.ZXing){
              // Fallback ZXing: decode desde canvas (más lento)
              if (!codeReader){
                const hints = new Map();
                hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                codeReader = new ZXing.BrowserMultiFormatReader(hints, 120);
              }
              const result = await codeReader.decodeFromCanvas(canvas);
              codeText = String(result && (result.getText ? result.getText() : result.text) || '').trim();
            }

            if (codeText){
              const now2 = Date.now();
              if (now2 - lastScanTs < SCAN_COOLDOWN_MS){
                requestAnimationFrame(loop);
                return;
              }
              if (codeText === lastScanText && (now2 - lastScanTs) < 2500){
                requestAnimationFrame(loop);
                return;
              }

              lastScanTs = now2;
              lastScanText = codeText;
              scanLockUntil = now2 + SCAN_LOCK_MS;

              lastCode.textContent = codeText;
              showScanName(codeText);
              beep(); vibrate();

              if (optAuto.checked){
                const ok = addItemDirect(codeText, {silent:true});
                notify(ok ? `Escaneado: ${codeText}` : 'No se pudo agregar', ok ? 'ok' : 'bad');
                lockScroll();
              } else {
                // En modo automático no escribimos en el input para evitar movimiento/teclado
                if (uiMode === 'manual') { claveEl.value = codeText; }
                notify(`Detectado: ${codeText}`, 'ok');
                lockScroll();
              }
            }
          }catch(e){
            // silencioso: no interrumpir el loop
          }

          requestAnimationFrame(loop);
        };

        requestAnimationFrame(loop);

        // guardamos para stop
        video.__scannerRunning = () => { running = false; };

      }catch(e){
        cameraActive = false;
        setStatus('error');
        notify('No se pudo abrir cámara (requiere HTTPS y permisos)', 'bad');
      }
    }

    function stopCam(){
      if (!cameraActive) return;
      cameraActive = false;

      try{ if (video.__scannerRunning) video.__scannerRunning(); }catch(e){}

      try{ if (controls) controls.stop(); }catch(e){}
      controls = null;

      try{ if (codeReader && codeReader.reset) codeReader.reset(); }catch(e){}
      codeReader = null;

      try{
        const stream = video.srcObject;
        if (stream && stream.getTracks) stream.getTracks().forEach(t=>t.stop());
      }catch(e){}
      video.srcObject = null;

      torchOn = false;
      setStatus('detenido');
    }

    btnCamStart.addEventListener('click', startCam);
    btnCamStop.addEventListener('click', stopCam);
    btnTorch.addEventListener('click', toggleTorch);
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopCam(); });

    render();

    if ('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
  </script>

  <div id="editModal" class="modal-edit" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <div class="mh">
        <div class="t" id="editTitle"><i class="fa-solid fa-pen-to-square"></i> Editar registro</div>
        <button class="btn-muted btn-mini" id="btnEditClose" type="button" aria-label="Cerrar"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="grid">
        <div class="full">
          <label>Clave</label>
          <input id="editClave" type="text" disabled />
        </div>
        <div class="full">
          <label>Nombre</label>
          <input id="editNombre" type="text" disabled />
        </div>
        <div>
          <label>Mes</label>
          <select id="editMes">
            <option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option><option>Mayo</option><option>Junio</option>
            <option>Julio</option><option>Agosto</option><option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
          </select>
        </div>
        <div>
          <label>Cantidad</label>
          <input id="editCantidad" type="number" min="0" step="1" inputmode="numeric" />
        </div>
      </div>

      <div class="hint" style="margin-top:10px;">
        Tip: Puedes cambiar el mes o ajustar la cantidad total. Si pones 0, se elimina esa clave en ese mes.
      </div>

      <div class="row">
        <button class="btn-muted" id="btnEditCancel" type="button"><i class="fa-solid fa-ban"></i> Cancelar</button>
        <button class="btn-primary" id="btnEditSave" type="button"><i class="fa-solid fa-floppy-disk"></i> Guardar</button>
      </div>
    </div>
  </div>

</body>
</html>
