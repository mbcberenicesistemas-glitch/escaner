<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Escáner de Artículos</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#2c3e50" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/@zxing/library@0.21.3"></script>

  <style>
    :root{
      --bg:#eef2f6;
      --card:#fff;
      --text:#253040;
      --muted:#6b7785;
      --primary:#2c3e50;
      --accent:#3498db;
      --ok:#2ecc71;
      --warn:#f39c12;
      --bad:#e74c3c;
      --border:#e3e9f0;
      --shadow:0 8px 22px rgba(18,38,63,.08);
      --radius:12px;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{background:var(--bg);color:var(--text);max-width:1080px;margin:0 auto;padding:14px;scroll-padding-top:90px}
    header{
      background:linear-gradient(135deg,#243243 0%,#2f4257 100%);
      color:#fff;border-radius:14px;box-shadow:var(--shadow);
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .h-left{display:flex;align-items:center;gap:12px}
    .h-left i{font-size:22px;color:#dce8f7}
    .h-left .t{font-size:20px;font-weight:900;letter-spacing:.2px}
    .h-right{font-size:12px;opacity:.9}
    .container{display:flex;flex-direction:column;gap:14px;margin-top:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:14px}
    .card-h{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:12px;
    }
    .card-h .ttl{display:flex;align-items:center;gap:10px;color:var(--primary);font-weight:950}
    .card-h .ttl i{color:var(--accent)}
    label{display:block;font-weight:800;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{
      width:100%;padding:12px 12px;border:1.8px solid #d4dde8;border-radius:10px;
      font-size:16px;outline:none;background:#fff;transition:.15s
    }
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(52,152,219,.18)}
    button{
      border:none;border-radius:10px;padding:12px 14px;font-weight:950;cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:.15s;user-select:none
    }
    .btn-ok{background:var(--ok);color:#fff}
    .btn-ok:hover{filter:brightness(.96);transform:translateY(-1px)}
    .btn-muted{background:#96a0a6;color:#fff}
    .btn-muted:hover{filter:brightness(.95);transform:translateY(-1px)}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-primary:hover{filter:brightness(.95);transform:translateY(-1px)}
    .btn-bad{background:var(--bad);color:#fff}
    .btn-bad:hover{filter:brightness(.95);transform:translateY(-1px)}
    .row{display:grid;grid-template-columns:220px 1fr 140px 240px;gap:12px;align-items:end}
    .row .btn-ok{width:100%}

    /* cámara layout como tu imagen */
    .cam-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;width:100%}
    .cam-actions .start{flex:1;min-width:220px}
    .cam-actions .stop{min-width:140px}
    .toggles{display:flex;gap:18px;flex-wrap:wrap;color:var(--muted);font-size:13px;margin-top:10px}
    .toggles label{display:flex;align-items:center;gap:8px;margin:0;font-weight:850;color:var(--muted)}
    .toggles input{width:auto;transform:scale(1.05)}
    .status{margin-top:10px;font-size:13px;color:var(--muted)}
    .video-wrap{
      width:100%;background:#000;border-radius:12px;border:1px solid var(--border);
      overflow:hidden;position:relative;margin-top:10px;aspect-ratio: 16/7;min-height:160px;
    }
    video{width:100%;height:100%;object-fit:cover;display:block}
    .scan-area{
      position:absolute;left:50%;top:50%;
      width:min(78%,520px);height:min(38%,180px);
      transform:translate(-50%,-50%);
      border:3px solid rgba(46,204,113,.95);
      border-radius:14px;
      box-shadow:0 0 0 9999px rgba(0,0,0,.25);
      pointer-events:none;
    }
    .scan-line{
      position:absolute;left:50%;top:50%;
      width:min(78%,520px);height:2px;
      transform:translate(-50%,-50%);
      background:rgba(46,204,113,.95);
      opacity:.85;pointer-events:none;
    }

    /* resultados */
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    .filters > div{min-width:220px}
    .actions-right{display:flex;gap:10px;flex-wrap:wrap}
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse;min-width:560px}
    th,td{padding:12px 10px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f7f9fb;font-weight:950;color:#1f2a37}
    .td-cad{font-weight:950;color:var(--bad)}
    .td-clave{font-weight:950}
    .td-cant{text-align:center;font-weight:950;color:var(--ok)}
    .summary{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-top:10px;color:var(--muted);font-weight:850}

    .danger{
      background:#fff7e6;border:1px solid rgba(243,156,18,.35);border-left:5px solid var(--warn);
      padding:12px;border-radius:12px;color:#5a4a10
    }

    /* toast */
    .toast{
      position:fixed;top:16px;right:16px;z-index:3000;
      background:var(--ok);color:#fff;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);
      display:flex;gap:10px;align-items:center;transform:translateX(140%);transition:.25s;
      max-width:min(92vw,520px)
    }
    .toast.show{transform:translateX(0)}
    .toast.bad{background:var(--bad)}
    .toast.warn{background:var(--warn)}

    /* modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:4000;align-items:center;justify-content:center}
    .modal .box{background:#fff;width:min(520px,92vw);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .modal .box h3{display:flex;align-items:center;gap:10px;color:var(--primary);margin-bottom:10px}
    .modal .box p{color:#4b5563;line-height:1.5;margin-bottom:14px}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}

    @media (max-width: 920px){ .row{grid-template-columns:1fr 1fr} }
    @media (max-width: 560px){ .row{grid-template-columns:1fr} .video-wrap{aspect-ratio:4/3} }
  </style>
</head>
<body>
  <header>
    <div class="h-left">
      <i class="fa-solid fa-boxes-stacked"></i>
      <div>
        <div class="t">Escáner de Artículos</div>
        <div style="font-size:12px;opacity:.86;">Versión 3.2</div>
      </div>
    </div>
    <div class="h-right">Caducidad + Clave + Cantidad</div>
  </header>

  <div class="container">
    <section class="card">
      <div class="row">
        <div>
          <label>Caducidad (Mes)</label>
          <select id="caducidad">
            <option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option><option>Mayo</option><option>Junio</option>
            <option selected>Julio</option><option>Agosto</option><option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
          </select>
        </div>
        <div>
          <label>Clave (Código)</label>
          <input id="clave" placeholder="Ej: 750... / CODE128 / ITF" autocomplete="off" / inputmode="none" enterkeyhint="done" autocapitalize="off" autocorrect="off" spellcheck="false">
        </div>
        <div>
          <label>Cantidad</label>
          <input id="cantidad" type="number" value="1" min="1" />
        </div>
        <div>
          <label style="visibility:hidden">Acción</label>
          <button class="btn-ok" id="btnAgregar" type="button"><i class="fa-solid fa-circle-plus"></i> Agregar Escaneo</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card-h">
        <div class="ttl"><i class="fa-solid fa-camera"></i> Escaneo con Cámara</div>
      </div>

      <div class="cam-actions">
        <button class="btn-ok start" id="btnCamStart" type="button"><i class="fa-solid fa-qrcode"></i> Iniciar Escaneo</button>
        <button class="btn-muted stop" id="btnCamStop" type="button"><i class="fa-solid fa-stop"></i> Detener</button>
        <button class="btn-primary" id="btnTorch" type="button" style="display:none;"><i class="fa-solid fa-lightbulb"></i> Luz</button>
      </div>

      <div class="toggles">
        <label><input id="optAuto" type="checkbox" checked> Auto-agregar al detectar</label>
        <label><input id="optSound" type="checkbox" checked> Sonido</label>
        <label><input id="optVib" type="checkbox" checked> Vibración</label>
      </div>

      <div class="status">
        Estado: <strong id="camStatus">detenido</strong> &nbsp;&nbsp;|&nbsp;&nbsp;
        Último: <strong id="lastCode">—</strong>
      </div>

      <div class="video-wrap">
        <video id="video" playsinline muted></video>
        <div class="scan-area"></div>
        <div class="scan-line"></div>
      </div>
    </section>

    <section class="card">
      <div class="card-h">
        <div class="ttl"><i class="fa-solid fa-list-check"></i> Resultados de Escaneo</div>
        <div class="actions-right">
          <button class="btn-primary" id="btnExport" type="button"><i class="fa-solid fa-file-arrow-down"></i> Exportar CSV</button>
        </div>
      </div>

      <div class="filters">
        <div>
          <label>Filtrar por Clave</label>
          <input id="fClave" placeholder="Ej: 750" />
        </div>
        <div>
          <label>Filtrar por Caducidad</label>
          <select id="fCad">
            <option value="">Todos</option>
            <option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option><option>Mayo</option><option>Junio</option>
            <option>Julio</option><option>Agosto</option><option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
          </select>
        </div>
        <div style="min-width:auto;">
          <label style="visibility:hidden">Acción</label>
          <button class="btn-muted" id="btnFiltrar" type="button"><i class="fa-solid fa-filter"></i> Filtrar</button>
        </div>
        <div style="min-width:auto;">
          <label style="visibility:hidden">Acción</label>
          <button class="btn-muted" id="btnLimpiarFiltro" type="button"><i class="fa-solid fa-xmark"></i> Limpiar Filtro</button>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:10px;">
        <div id="tablaWrap" style="min-height:160px;"></div>
      </div>

      <div class="summary">
        <div>Total de escaneos: <strong id="sumScans">0</strong></div>
        <div>Claves diferentes: <strong id="sumUnique">0</strong></div>
        <div>Total unidades: <strong id="sumUnits">0</strong></div>
      </div>
    </section>

    <section class="card">
      <div class="card-h">
        <div class="ttl"><i class="fa-solid fa-triangle-exclamation" style="color:var(--warn)"></i> Zona de Peligro</div>
      </div>
      <div class="danger">
        <strong>Advertencia:</strong> Esta acción elimina todos los datos guardados en el dispositivo.
      </div>
      <div style="margin-top:12px;">
        <button class="btn-bad" id="btnClearAll" type="button" style="width:100%;"><i class="fa-solid fa-trash"></i> Limpiar Todos los Datos</button>
      </div>
    </section>
  </div>

  <div id="toast" class="toast"><i class="fa-solid fa-circle-check"></i><div id="toastMsg" style="font-weight:950;">OK</div></div>

  <div id="modal" class="modal">
    <div class="box">
      <h3><i class="fa-solid fa-triangle-exclamation" style="color:var(--bad)"></i> Confirmar Eliminación</h3>
      <p>¿Seguro que quieres borrar todos los datos? No se puede deshacer.</p>
      <div class="actions">
        <button class="btn-muted" id="btnCancel" type="button"><i class="fa-solid fa-xmark"></i> Cancelar</button>
        <button class="btn-bad" id="btnConfirm" type="button"><i class="fa-solid fa-check"></i> Sí, Borrar</button>
      </div>
    </div>
  </div>

  <script>
    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');
    let toastT = null;
    function notify(msg, type='ok'){
      toastMsg.textContent = msg;
      toast.className = 'toast show' + (type==='bad' ? ' bad' : type==='warn' ? ' warn' : '');
      clearTimeout(toastT);
      toastT = setTimeout(()=>toast.classList.remove('show'), 1600);
    }

    const optSound = document.getElementById('optSound');
    const optVib = document.getElementById('optVib');
    const optAuto = document.getElementById('optAuto');

    let audioCtx = null;
    function unlockAudio(){
      try{
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
      }catch(e){}
    }
    function beep(){
      if (!optSound.checked) return;
      try{
        unlockAudio();
        if (!audioCtx) return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine';
        o.frequency.value = 880;
        g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.25, audioCtx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.12);
        o.connect(g); g.connect(audioCtx.destination);
        o.start();
        o.stop(audioCtx.currentTime + 0.13);
      }catch(e){}
    }
    function vibrate(){ if (optVib.checked && navigator.vibrate) navigator.vibrate(100); }

    function loadPrefs(){
      const p = JSON.parse(localStorage.getItem('scannerPrefs') || '{}');
      optAuto.checked = p.auto !== false;
      optSound.checked = p.sound !== false;
      optVib.checked = p.vib !== false;
    }
    function savePrefs(){
      localStorage.setItem('scannerPrefs', JSON.stringify({ auto: optAuto.checked, sound: optSound.checked, vib: optVib.checked }));
    }
    optAuto.addEventListener('change', savePrefs);
    optSound.addEventListener('change', savePrefs);
    optVib.addEventListener('change', savePrefs);
    loadPrefs();

    const caducidadEl = document.getElementById('caducidad');
    const claveEl = document.getElementById('clave');
    const cantidadEl = document.getElementById('cantidad');
    const btnAgregar = document.getElementById('btnAgregar');

    const fClave = document.getElementById('fClave');
    const fCad = document.getElementById('fCad');
    const btnFiltrar = document.getElementById('btnFiltrar');
    const btnLimpiarFiltro = document.getElementById('btnLimpiarFiltro');
    const tablaWrap = document.getElementById('tablaWrap');

    const sumScans = document.getElementById('sumScans');
    const sumUnique = document.getElementById('sumUnique');
    const sumUnits = document.getElementById('sumUnits');

    let items = JSON.parse(localStorage.getItem('scannerData') || 'null') || [];
    let curFilterClave = '';
    let curFilterCad = '';

    function saveData(){ localStorage.setItem('scannerData', JSON.stringify(items)); }
    function escapeHtml(s){
      return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
    }

    function addItemFromInputs({silent=false} = {}){
      const cad = caducidadEl.value;
      const clave = (claveEl.value || '').trim();
      const cant = parseInt((cantidadEl.value || '0'), 10);

      if (!cad){ if(!silent) notify('Selecciona caducidad', 'bad'); return false; }
      if (!clave){ if(!silent) notify('Introduce clave', 'bad'); return false; }
      if (!cant || isNaN(cant) || cant <= 0){ if(!silent) notify('Cantidad inválida', 'bad'); return false; }

      items.push({ caducidad: cad, clave, cantidad: cant });
      saveData();
      render();
      beep(); vibrate();

      claveEl.value = '';
      cantidadEl.value = '1';
      claveEl.focus();

      if(!silent) notify('Agregado', 'ok');
      return true;
    }

    function process(){
      let filtered = items.slice();
      if (curFilterClave) filtered = filtered.filter(i => i.clave.toLowerCase().includes(curFilterClave.toLowerCase()));
      if (curFilterCad) filtered = filtered.filter(i => i.caducidad.toLowerCase() === curFilterCad.toLowerCase());

      const grouped = {};
      let units = 0;
      const uniq = new Set();

      for (const it of filtered){
        const k = it.clave + '|' + it.caducidad;
        if (!grouped[k]) grouped[k] = { caducidad: it.caducidad, clave: it.clave, cantidad: 0 };
        grouped[k].cantidad += it.cantidad;
        units += it.cantidad;
        uniq.add(it.clave);
      }

      const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
      const results = Object.values(grouped).sort((a,b) => {
        if (a.caducidad === b.caducidad) return a.clave.localeCompare(b.clave);
        return months.indexOf(a.caducidad) - months.indexOf(b.caducidad);
      });

      return { results, scans: filtered.length, uniq: uniq.size, units };
    }

    function render(){
      const { results, scans, uniq, units } = process();
      sumScans.textContent = scans;
      sumUnique.textContent = uniq;
      sumUnits.textContent = units;

      if (!results.length){
        tablaWrap.innerHTML = `
          <div style="padding:26px; text-align:center; color:var(--muted);">
            <i class="fa-regular fa-clipboard" style="font-size:34px; opacity:.5;"></i>
            <div style="margin-top:10px; font-weight:950;">${items.length ? 'No hay resultados con filtros.' : 'No hay artículos aún.'}</div>
          </div>`;
        return;
      }

      let html = `<table><thead><tr><th>Caducidad</th><th>Clave</th><th style="text-align:center;">Cantidad</th></tr></thead><tbody>`;
      for (const r of results){
        html += `<tr>
          <td class="td-cad">${r.caducidad}</td>
          <td class="td-clave">${escapeHtml(r.clave)}</td>
          <td class="td-cant">${r.cantidad}</td>
        </tr>`;
      }
      html += `</tbody></table>`;
      tablaWrap.innerHTML = html;
    }

    btnAgregar.addEventListener('click', ()=>{ unlockAudio(); addItemFromInputs(); });
    claveEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ unlockAudio(); addItemFromInputs(); } });
    // Muchos lectores físicos envían ENTER al final. Si el foco está en Clave, agregamos.
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && document.activeElement === claveEl){
        e.preventDefault();
        unlockAudio();
        addItemFromInputs();
      }
    });


    btnFiltrar.addEventListener('click', ()=>{
      curFilterClave = (fClave.value||'').trim();
      curFilterCad = fCad.value || '';
      render();
      notify('Filtro aplicado', 'ok');
    });
    btnLimpiarFiltro.addEventListener('click', ()=>{
      fClave.value=''; fCad.value='';
      curFilterClave=''; curFilterCad='';
      render();
      notify('Filtro limpiado', 'ok');
    });

    document.getElementById('btnExport').addEventListener('click', ()=>{
      const { results } = process();
      if (!results.length){ notify('No hay datos para exportar', 'bad'); return; }
      let csv = "Caducidad,Clave,Cantidad\n";
      for (const r of results){
        csv += `"${r.caducidad}","${String(r.clave).replaceAll('"','""')}",${r.cantidad}\n`;
      }
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `escaneos_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      notify('CSV descargado', 'ok');
    });

    const modal = document.getElementById('modal');
    document.getElementById('btnClearAll').addEventListener('click', ()=>{
      if (!items.length){ notify('No hay datos', 'warn'); return; }
      modal.style.display='flex';
    });
    document.getElementById('btnCancel').addEventListener('click', ()=> modal.style.display='none');
    document.getElementById('btnConfirm').addEventListener('click', ()=>{
      items = [];
      saveData();
      render();
      modal.style.display='none';
      notify('Datos eliminados', 'warn');
    });
    modal.addEventListener('click', (e)=>{ if(e.target === modal) modal.style.display='none'; });

    // Cámara
    const btnCamStart = document.getElementById('btnCamStart');
    const btnCamStop = document.getElementById('btnCamStop');
    const btnTorch = document.getElementById('btnTorch');
    const video = document.getElementById('video');
    const camStatus = document.getElementById('camStatus');
    const lastCode = document.getElementById('lastCode');

    let codeReader = null;
    let lastScanTs = 0;
    let lastScanText = '';
    const SCAN_COOLDOWN_MS = 650; // evita doble lectura

    let controls = null;
    let cameraActive = false;
    let torchOn = false;

    function setStatus(s){ camStatus.textContent = s; }
    function getRoiRect(){
      const area = document.querySelector('.scan-area');
      const r = area.getBoundingClientRect();
      const vr = video.getBoundingClientRect();
      const x = (r.left - vr.left) / vr.width;
      const y = (r.top - vr.top) / vr.height;
      const w = r.width / vr.width;
      const h = r.height / vr.height;
      return {x, y, w, h};
    }
    function inRoiFromResult(result){
      const pts = result.resultPoints || (result.getResultPoints && result.getResultPoints()) || [];
      if (!pts || !pts.length) return true;
      const vw = video.videoWidth || 0;
      const vh = video.videoHeight || 0;
      if (!vw || !vh) return true;

      let minX=1e9, minY=1e9, maxX=-1e9, maxY=-1e9;
      for (const p of pts){
        const x = (p && (p.x ?? (p.getX && p.getX()))) ?? 0;
        const y = (p && (p.y ?? (p.getY && p.getY()))) ?? 0;
        minX = Math.min(minX, x); minY = Math.min(minY, y);
        maxX = Math.max(maxX, x); maxY = Math.max(maxY, y);
      }
      const cx = (minX + maxX) / 2;
      const cy = (minY + maxY) / 2;
      const nx = cx / vw;
      const ny = cy / vh;

      const roi = getRoiRect();
      const pad = 0.03;
      return (nx >= roi.x - pad && nx <= roi.x + roi.w + pad && ny >= roi.y - pad && ny <= roi.y + roi.h + pad);
    }


    async function applyTrackTweaks(track){
      try{
        const caps = track.getCapabilities ? track.getCapabilities() : null;
        if (!caps) return;
        if (caps.torch) btnTorch.style.display = 'inline-flex';

        const adv = [];
        if (caps.focusMode && caps.focusMode.includes('continuous')) adv.push({ focusMode: 'continuous' });
        if (caps.exposureMode && caps.exposureMode.includes('continuous')) adv.push({ exposureMode: 'continuous' });
        if (caps.whiteBalanceMode && caps.whiteBalanceMode.includes('continuous')) adv.push({ whiteBalanceMode: 'continuous' });
        if (caps.zoom){
          const z = Math.min(caps.zoom.max ?? 2, 2);
          const z2 = Math.max(caps.zoom.min ?? 1, z);
          adv.push({ zoom: z2 });
        }
        if (adv.length) await track.applyConstraints({ advanced: adv });
      }catch(e){}
    }

    async function toggleTorch(){
      try{
        const stream = video.srcObject;
        if (!stream) return;
        const track = stream.getVideoTracks()[0];
        const caps = track.getCapabilities ? track.getCapabilities() : null;
        if (!caps || !caps.torch) return;
        torchOn = !torchOn;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        notify(torchOn ? 'Luz encendida' : 'Luz apagada', 'ok');
      }catch(e){
        notify('Tu cámara no permite luz', 'warn');
      }
    }

    async function startCam(){
      if (cameraActive) return;
      unlockAudio();
      if (!window.ZXing){ notify('No cargó ZXing (HTTPS)', 'bad'); return; }

      cameraActive = true;
      setStatus('iniciando...');

      try{
        const hints = new Map();
        const formats = [
          ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8,
          ZXing.BarcodeFormat.UPC_A, ZXing.BarcodeFormat.UPC_E,
          ZXing.BarcodeFormat.CODE_128, ZXing.BarcodeFormat.CODE_39,
          ZXing.BarcodeFormat.ITF, ZXing.BarcodeFormat.QR_CODE
        ];
        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
        hints.set(ZXing.DecodeHintType.TRY_HARDER, true);

        codeReader = new ZXing.BrowserMultiFormatReader(hints, 120);

        const constraints = {
          audio: false,
          video: { facingMode: { ideal: "environment" }, width: { ideal: 1920 }, height: { ideal: 1080 } }
        };

        controls = await codeReader.decodeFromConstraints(constraints, video, (result, err)=>{
          if (!result) return;

          const now = Date.now();
          if (now - lastScanTs < SCAN_COOLDOWN_MS) return;

          try{
            if (!inRoiFromResult(result)) return;
          }catch(e){}

          const text = String(result.getText ? result.getText() : result.text).trim();
          if (!text) return;

          if (text === lastScanText && (now - lastScanTs) < 2500) return;

          lastScanTs = now;
          lastScanText = text;

          lastCode.textContent = text;
          beep(); vibrate();

          if (optAuto.checked){
            claveEl.value = text;
            const ok = addItemFromInputs({silent:true});
            notify(ok ? `Escaneado: ${text}` : 'No se pudo agregar', ok ? 'ok' : 'bad');
          } else {
            claveEl.value = text;
            notify(`Detectado: ${text}`, 'ok');
          }
        });

        notify(ok ? `Escaneado: ${text}` : 'No se pudo agregar', ok ? 'ok' : 'bad');
              stopCam();
            } else {
              claveEl.value = text;
              notify(`Detectado: ${text}`, 'ok');
            }
          }
        });

        setStatus('escaneando');

        setTimeout(async ()=>{
          const stream = video.srcObject;
          if (!stream) return;
          const track = stream.getVideoTracks()[0];
          if (track) await applyTrackTweaks(track);
        }, 500);

      }catch(e){
        cameraActive = false;
        setStatus('error');
        notify('No se pudo abrir cámara', 'bad');
      }
    }

    function stopCam(){
      if (!cameraActive) return;
      cameraActive = false;

      try{ if (controls) controls.stop(); }catch(e){}
      controls = null;

      try{ if (codeReader) codeReader.reset(); }catch(e){}
      codeReader = null;

      try{
        const stream = video.srcObject;
        if (stream && stream.getTracks) stream.getTracks().forEach(t=>t.stop());
      }catch(e){}
      video.srcObject = null;

      torchOn = false;
      setStatus('detenido');
    }

    btnCamStart.addEventListener('click', startCam);
    btnCamStop.addEventListener('click', stopCam);
    btnTorch.addEventListener('click', toggleTorch);
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopCam(); });

    render();

    if ('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
